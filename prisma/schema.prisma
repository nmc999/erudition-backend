// Erudition Database Schema
// Complete schema for buxiban management system

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ======================
// CORE MODELS
// ======================

model School {
  id        String   @id @default(uuid())
  name      String
  address   String?
  phone     String?
  email     String?
  
  // SaaS: Subdomain & Branding
  subdomain         String   @unique
  logoUrl           String?
  primaryColor      String   @default("#4f46e5")  // Indigo
  secondaryColor    String   @default("#0ea5e9")  // Sky blue
  
  // SaaS: Billing
  billingEmail      String?
  stripeCustomerId  String?  @unique
  subscriptionStatus SubscriptionStatus @default(ACTIVE)
  pricePerStudent   Int      @default(50)  // NT$ per student per month
  
  // SaaS: Teacher Permissions (configurable by admin)
  teacherCanMessageWithoutApproval Boolean @default(true)
  teacherCanEditStudents           Boolean @default(false)
  teacherCanViewAllClasses         Boolean @default(false)
  teacherCanManageAttendance       Boolean @default(true)
  teacherCanGradeHomework          Boolean @default(true)
  teacherCanCreateHomework         Boolean @default(true)
  teacherCanViewParentContacts     Boolean @default(true)
  
  // SaaS: Parent Permissions
  parentCanMessageTeachers         Boolean @default(true)
  parentCanViewGrades              Boolean @default(true)
  parentCanViewAttendance          Boolean @default(true)
  
  // LINE Official Account credentials (encrypted in production)
  lineChannelId     String?
  lineChannelSecret String?
  lineAccessToken   String?
  
  // Settings
  settings  Json?    @default("{}")
  timezone  String   @default("Asia/Taipei")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users              User[]
  classes            Class[]
  students           Student[]
  invoices           Invoice[]
  platformInvoices   PlatformInvoice[]
  platformPayments   PlatformPayment[]
  teacherProfiles    TeacherProfile[]
  documents          Document[]
  timesheets         Timesheet[]
  pricingRules       PricingRule[]
  expenses           Expense[]
  revenues           Revenue[]
  emailIntegrations  EmailIntegration[]

  @@map("schools")
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  SUSPENDED
}

model User {
  id              String   @id @default(uuid())
  email           String?  @unique
  passwordHash    String?
  
  // LINE Integration
  lineUserId      String?  @unique
  lineDisplayName String?
  lineProfileUrl  String?
  lineAccessToken String?
  
  // Profile
  firstName       String
  lastName        String
  phone           String?
  role            UserRole
  preferredLang   String   @default("zh-TW")
  
  // Platform Super Admin (can manage all schools)
  isSuperAdmin    Boolean  @default(false)
  
  // Status
  isActive        Boolean  @default(true)
  lastLoginAt     DateTime?
  
  // Multi-tenancy (optional for super admins)
  schoolId        String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  school              School?             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teachingClasses     Class[]             @relation("ClassTeacher")
  attendanceMarked    Attendance[]        @relation("MarkedBy")
  homeworkCreated     Homework[]          @relation("HomeworkCreator")
  homeworkGraded      HomeworkSubmission[] @relation("GradedBy")
  messagesSent        Message[]           @relation("MessageSender")
  messagesReceived    Message[]           @relation("MessageRecipient")
  parentRelations     ParentStudent[]     @relation("ParentUser")
  lessonPlans         LessonPlan[]        @relation("LessonCreator")
  uploadedMaterials   TeachingMaterial[]  @relation("MaterialUploader")
  teacherProfile      TeacherProfile?
  emailIntegrations   EmailIntegration[]

  @@index([schoolId])
  @@index([lineUserId])
  @@index([email])
  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  TEACHER
  PARENT
  STUDENT
}

// ======================
// STUDENT MANAGEMENT
// ======================

model Student {
  id                   String   @id @default(uuid())
  
  // Basic Info
  firstName            String
  lastName             String
  englishName          String?
  dateOfBirth          DateTime?
  gender               String?
  
  // Contact
  phone                String?
  email                String?
  address              String?
  
  // Medical & Emergency
  medicalInfo          String?
  allergies            String?
  emergencyContactName String?
  emergencyContactPhone String?
  emergencyContactRelation String?
  
  // Academic
  enrollmentDate       DateTime @default(now())
  status               StudentStatus @default(ACTIVE)
  notes                String?
  
  // Photo (stored as URL)
  photoUrl             String?
  
  // Multi-tenancy
  schoolId             String
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  school               School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  enrollments          ClassEnrollment[]
  attendance           Attendance[]
  homeworkSubmissions  HomeworkSubmission[]
  parentRelations      ParentStudent[]
  invoices             Invoice[]
  payments             Payment[]

  @@index([schoolId])
  @@index([status])
  @@map("students")
}

enum StudentStatus {
  ACTIVE
  INACTIVE
  GRADUATED
  WITHDRAWN
}

model ParentStudent {
  id           String @id @default(uuid())
  parentId     String
  studentId    String
  relationship String // mother, father, guardian, grandparent, other
  isPrimary    Boolean @default(false)
  
  createdAt    DateTime @default(now())

  parent       User    @relation("ParentUser", fields: [parentId], references: [id], onDelete: Cascade)
  student      Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([parentId, studentId])
  @@map("parent_students")
}

// ======================
// CLASS MANAGEMENT
// ======================

model Class {
  id          String   @id @default(uuid())
  name        String
  description String?
  
  // Schedule info
  dayOfWeek   String?  // e.g., "Monday,Wednesday,Friday"
  startTime   String?  // e.g., "16:00"
  endTime     String?  // e.g., "18:00"
  
  // Capacity
  maxStudents Int      @default(20)
  
  // Academic period
  academicYear String?
  term         String?
  
  // Multi-tenancy
  schoolId    String
  teacherId   String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  school      School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacher     User?            @relation("ClassTeacher", fields: [teacherId], references: [id])
  enrollments ClassEnrollment[]
  attendance  Attendance[]
  homework    Homework[]
  messages    Message[]
  lessonPlans LessonPlan[]
  materials   TeachingMaterial[]
  timesheets  Timesheet[]
  pricingRules PricingRule[]

  @@index([schoolId])
  @@index([teacherId])
  @@map("classes")
}

model ClassEnrollment {
  id             String   @id @default(uuid())
  classId        String
  studentId      String
  enrollmentDate DateTime @default(now())
  status         EnrollmentStatus @default(ACTIVE)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  class          Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  student        Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
  @@map("class_enrollments")
}

enum EnrollmentStatus {
  ACTIVE
  DROPPED
  COMPLETED
}

// ======================
// ATTENDANCE
// ======================

model Attendance {
  id          String           @id @default(uuid())
  date        DateTime         @db.Date
  status      AttendanceStatus
  reason      String?
  notes       String?
  
  // Check-in/out times (optional)
  checkInTime  DateTime?
  checkOutTime DateTime?
  
  // Who marked this attendance
  markedById  String
  markedAt    DateTime         @default(now())
  
  // Parent notification tracking
  parentNotified   Boolean   @default(false)
  parentNotifiedAt DateTime?
  
  // Relations
  classId     String
  studentId   String
  
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  class       Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  student     Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  markedBy    User    @relation("MarkedBy", fields: [markedById], references: [id])

  @@unique([classId, studentId, date])
  @@index([classId, date])
  @@index([studentId, date])
  @@map("attendance")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
  EARLY_LEAVE
}

// ======================
// HOMEWORK
// ======================

model Homework {
  id          String   @id @default(uuid())
  title       String
  description String?
  
  // Due date
  dueDate     DateTime
  
  // Attachments (stored as JSON array of URLs)
  attachments Json?    @default("[]")
  
  // Scoring
  maxScore    Int?
  
  // Settings
  allowLateSubmission Boolean @default(true)
  
  // Relations
  classId     String
  createdById String
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  class       Class               @relation(fields: [classId], references: [id], onDelete: Cascade)
  createdBy   User                @relation("HomeworkCreator", fields: [createdById], references: [id])
  submissions HomeworkSubmission[]

  @@index([classId])
  @@index([dueDate])
  @@map("homework")
}

model HomeworkSubmission {
  id           String   @id @default(uuid())
  
  // Submission content
  content      String?
  attachments  Json?    @default("[]")
  
  // Timestamps
  submittedAt  DateTime @default(now())
  
  // Grading
  score        Int?
  feedback     String?
  gradedById   String?
  gradedAt     DateTime?
  
  // Status
  status       SubmissionStatus @default(PENDING)
  
  // Relations
  homeworkId   String
  studentId    String
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  homework     Homework @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  student      Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  gradedBy     User?    @relation("GradedBy", fields: [gradedById], references: [id])

  @@unique([homeworkId, studentId])
  @@index([homeworkId])
  @@index([studentId])
  @@map("homework_submissions")
}

enum SubmissionStatus {
  PENDING
  SUBMITTED
  LATE
  GRADED
  RETURNED
}

// ======================
// MESSAGING
// ======================

model Message {
  id               String   @id @default(uuid())
  
  // Content
  originalText     String
  originalLang     String   @default("zh-TW")
  translatedText   String?
  translatedLang   String?
  
  // Attachments
  attachments      Json?    @default("[]")
  
  // LINE integration
  sentViaLine      Boolean  @default(false)
  lineMessageId    String?
  
  // Read status
  readAt           DateTime?
  
  // Threading (for replies)
  threadId         String?
  parentMessageId  String?
  
  // For class announcements
  isAnnouncement   Boolean  @default(false)
  classId          String?
  
  // Sender & Recipient
  senderId         String
  recipientId      String?  // null for class announcements
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  sender           User     @relation("MessageSender", fields: [senderId], references: [id])
  recipient        User?    @relation("MessageRecipient", fields: [recipientId], references: [id])
  class            Class?   @relation(fields: [classId], references: [id])
  parentMessage    Message? @relation("MessageThread", fields: [parentMessageId], references: [id])
  replies          Message[] @relation("MessageThread")
  fileAttachments  MessageAttachment[]

  @@index([senderId])
  @@index([recipientId])
  @@index([classId])
  @@index([threadId])
  @@map("messages")
}

// ======================
// FINANCIAL
// ======================

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique
  
  // Amount
  amount        Decimal       @db.Decimal(10, 2)
  currency      String        @default("TWD")
  
  // Dates
  issueDate     DateTime      @default(now())
  dueDate       DateTime
  
  // Payment
  status        InvoiceStatus @default(PENDING)
  paidAt        DateTime?
  paidAmount    Decimal?      @db.Decimal(10, 2)
  paymentMethod String?
  
  // Description
  description   String?
  notes         String?
  
  // Reminder tracking
  reminderSentAt DateTime?
  reminderCount  Int          @default(0)
  
  // Relations
  schoolId      String
  studentId     String
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  school        School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student       Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  items         InvoiceItem[]
  payments      Payment[]

  @@index([schoolId])
  @@index([studentId])
  @@index([status])
  @@map("invoices")
}

model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String
  description String
  amount      Decimal  @db.Decimal(10, 2)
  quantity    Int      @default(1)
  
  createdAt   DateTime @default(now())
  
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@map("invoice_items")
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

// ======================
// TRANSLATION CACHE
// ======================

model TranslationCache {
  id             String   @id @default(uuid())
  sourceText     String
  sourceLang     String
  targetLang     String
  translatedText String
  engine         String   @default("deepl")
  usageCount     Int      @default(1)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([sourceText, sourceLang, targetLang])
  @@index([sourceText])
  @@map("translation_cache")
}

// ======================
// PUBLIC REGISTRATION
// ======================

model Registration {
  id                String   @id @default(uuid())
  
  // Student Info
  studentFirstName  String
  studentLastName   String
  studentEnglishName String?
  studentDob        DateTime?
  studentGender     String?
  studentPhone      String?
  studentEmail      String?
  
  // Parent Info
  parentFirstName   String
  parentLastName    String
  parentPhone       String
  parentEmail       String?
  parentRelation    String?
  
  // Emergency Contact
  emergencyName     String?
  emergencyPhone    String?
  emergencyRelation String?
  
  // Medical Info
  allergies         String?
  medicalInfo       String?
  
  // Address
  address           String?
  
  // Preferences
  interestedClasses String[]
  howDidYouHear     String?
  notes             String?
  
  // PDPA Consent (Taiwan)
  consentDataCollection Boolean @default(false)
  consentHealthData     Boolean @default(false)
  consentPrivacyPolicy  Boolean @default(false)
  consentTimestamp      DateTime @default(now())
  
  // Processing
  status            RegistrationStatus @default(PENDING)
  processedById     String?
  processedAt       DateTime?
  processNotes      String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([status])
  @@map("registrations")
}

enum RegistrationStatus {
  PENDING
  CONTACTED
  SCHEDULED_TRIAL
  ENROLLED
  DECLINED
  CANCELLED
}

// ======================
// CURRICULUM
// ======================

model LessonPlan {
  id          String   @id @default(uuid())
  title       String
  date        DateTime @db.Date
  duration    Int      @default(90) // minutes
  
  // Content
  objectives  String?
  content     String?
  materials   String?
  homework    String?
  notes       String?
  
  // Status
  status      LessonStatus @default(SCHEDULED)
  
  // Relations
  classId     String
  createdById String
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  class       Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  createdBy   User     @relation("LessonCreator", fields: [createdById], references: [id])

  @@index([classId])
  @@index([date])
  @@map("lesson_plans")
}

enum LessonStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model TeachingMaterial {
  id           String   @id @default(uuid())
  title        String
  type         String   @default("document") // document, video, flashcards, link, other
  description  String?
  url          String?
  fileSize     Int?
  
  // Relations
  classId      String
  uploadedById String
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  class        Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  uploadedBy   User     @relation("MaterialUploader", fields: [uploadedById], references: [id])

  @@index([classId])
  @@index([type])
  @@map("teaching_materials")
}

// ======================
// PAYMENTS
// ======================

model Payment {
  id              String        @id @default(uuid())
  
  // Transaction
  merchantTradeNo String        @unique
  gatewayTradeNo  String?
  amount          Decimal       @db.Decimal(10, 2)
  method          String        // credit_card, line_pay, atm, cvs
  paymentType     String?       // Actual payment type from gateway
  
  // Status
  status          PaymentStatus @default(PENDING)
  errorMessage    String?
  
  // Timestamps
  paidAt          DateTime?
  
  // Relations
  invoiceId       String
  studentId       String
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  invoice         Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  student         Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([status])
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

// ======================
// PLATFORM BILLING (SaaS)
// ======================

model PlatformInvoice {
  id              String                @id @default(uuid())
  
  // Invoice details
  invoiceNumber   String                @unique
  billingPeriodStart DateTime
  billingPeriodEnd   DateTime
  
  // Calculation
  studentCount    Int
  pricePerStudent Int                   @default(50)  // NT$
  subtotal        Decimal               @db.Decimal(10, 2)
  tax             Decimal               @default(0)   @db.Decimal(10, 2)
  total           Decimal               @db.Decimal(10, 2)
  
  // Status
  status          PlatformInvoiceStatus @default(PENDING)
  dueDate         DateTime
  paidAt          DateTime?
  
  // School relation
  schoolId        String
  school          School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Payments
  payments        PlatformPayment[]
  
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@index([schoolId])
  @@index([status])
  @@index([billingPeriodStart])
  @@map("platform_invoices")
}

enum PlatformInvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

model PlatformPayment {
  id              String                @id @default(uuid())
  
  // Transaction
  stripePaymentId String?               @unique
  amount          Decimal               @db.Decimal(10, 2)
  method          String                @default("credit_card")
  
  // Status
  status          PaymentStatus         @default(PENDING)
  errorMessage    String?
  
  // Timestamps
  paidAt          DateTime?
  
  // Relations
  invoiceId       String
  schoolId        String
  
  invoice         PlatformInvoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  school          School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@index([invoiceId])
  @@index([schoolId])
  @@index([status])
  @@map("platform_payments")
}

// ======================
// TEACHER HR MANAGEMENT
// ======================

model TeacherProfile {
  id              String   @id @default(uuid())
  
  // Employment Info
  employeeId      String?  // Internal employee number
  hireDate        DateTime?
  terminationDate DateTime?
  employmentType  EmploymentType @default(FULL_TIME)
  status          EmploymentStatus @default(ACTIVE)
  
  // Compensation
  payType         PayType  @default(HOURLY)
  hourlyRate      Decimal? @db.Decimal(10, 2)
  monthlySalary   Decimal? @db.Decimal(10, 2)
  
  // Banking (for payroll)
  bankName        String?
  bankAccount     String?
  
  // Emergency Contact
  emergencyName   String?
  emergencyPhone  String?
  emergencyRelation String?
  
  // Notes
  notes           String?
  
  // Relations
  userId          String   @unique
  schoolId        String
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  school          School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  documents       Document[]
  timesheets      Timesheet[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([schoolId])
  @@index([status])
  @@map("teacher_profiles")
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  SUBSTITUTE
}

enum EmploymentStatus {
  ACTIVE
  ON_LEAVE
  TERMINATED
  RESIGNED
}

enum PayType {
  HOURLY
  SALARY
}

model Document {
  id              String       @id @default(uuid())
  
  // Document Info
  name            String
  type            DocumentType
  description     String?
  
  // File
  fileUrl         String
  fileName        String
  fileSize        Int          // bytes
  mimeType        String
  
  // Expiration (for certifications, contracts)
  expiresAt       DateTime?
  
  // Relations
  teacherProfileId String
  uploadedById    String
  schoolId        String
  
  teacherProfile  TeacherProfile @relation(fields: [teacherProfileId], references: [id], onDelete: Cascade)
  school          School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([teacherProfileId])
  @@index([type])
  @@map("documents")
}

enum DocumentType {
  CONTRACT
  CERTIFICATION
  ID_DOCUMENT
  RESUME
  BACKGROUND_CHECK
  TAX_FORM
  OTHER
}

model Timesheet {
  id              String   @id @default(uuid())
  
  // Time Entry
  date            DateTime @db.Date
  scheduledStart  String?  // "09:00"
  scheduledEnd    String?  // "17:00"
  actualStart     String?
  actualEnd       String?
  
  // Hours
  scheduledHours  Decimal  @db.Decimal(5, 2)
  actualHours     Decimal? @db.Decimal(5, 2)
  
  // Status
  status          TimesheetStatus @default(SCHEDULED)
  
  // Notes
  notes           String?
  
  // Relations
  teacherProfileId String
  classId         String?
  schoolId        String
  
  teacherProfile  TeacherProfile @relation(fields: [teacherProfileId], references: [id], onDelete: Cascade)
  class           Class?         @relation(fields: [classId], references: [id])
  school          School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([teacherProfileId, date, classId])
  @@index([teacherProfileId])
  @@index([date])
  @@index([schoolId])
  @@map("timesheets")
}

enum TimesheetStatus {
  SCHEDULED
  COMPLETED
  ABSENT
  CANCELLED
}

// ======================
// FINANCE AUTOMATION
// ======================

model PricingRule {
  id              String   @id @default(uuid())
  
  // Rule Info
  name            String
  description     String?
  
  // Pricing
  priceType       PriceType @default(PER_CLASS)
  amount          Decimal   @db.Decimal(10, 2)
  
  // Applicability
  classId         String?  // null = applies to all classes
  
  // Validity
  validFrom       DateTime?
  validUntil      DateTime?
  isActive        Boolean  @default(true)
  
  // Relations
  schoolId        String
  
  school          School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  class           Class?   @relation(fields: [classId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([schoolId])
  @@index([classId])
  @@map("pricing_rules")
}

enum PriceType {
  PER_CLASS       // Per class session attended
  PER_MONTH       // Monthly flat fee
  PER_SEMESTER    // Semester fee
  PACKAGE         // Package deal
}

model Expense {
  id              String   @id @default(uuid())
  
  // Expense Info
  category        ExpenseCategory
  description     String
  
  // Amount
  amount          Decimal  @db.Decimal(10, 2)
  currency        String   @default("TWD")
  
  // Date
  expenseDate     DateTime @db.Date
  
  // Receipt
  receiptUrl      String?
  
  // Approval
  status          ExpenseStatus @default(PENDING)
  approvedById    String?
  approvedAt      DateTime?
  
  // Notes
  notes           String?
  
  // Relations
  schoolId        String
  createdById     String
  
  school          School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([schoolId])
  @@index([category])
  @@index([expenseDate])
  @@map("expenses")
}

enum ExpenseCategory {
  RENT
  UTILITIES
  SUPPLIES
  MARKETING
  PAYROLL
  EQUIPMENT
  MAINTENANCE
  INSURANCE
  TAXES
  OTHER
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

model Revenue {
  id              String   @id @default(uuid())
  
  // Revenue Info
  category        RevenueCategory
  description     String
  
  // Amount
  amount          Decimal  @db.Decimal(10, 2)
  currency        String   @default("TWD")
  
  // Date
  revenueDate     DateTime @db.Date
  
  // Source
  invoiceId       String?  // Link to invoice if applicable
  
  // Notes
  notes           String?
  
  // Relations
  schoolId        String
  createdById     String
  
  school          School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([schoolId])
  @@index([category])
  @@index([revenueDate])
  @@map("revenues")
}

enum RevenueCategory {
  TUITION
  REGISTRATION_FEE
  MATERIALS
  LATE_FEE
  OTHER
}

// ======================
// MESSAGE ATTACHMENTS
// ======================

model MessageAttachment {
  id              String   @id @default(uuid())
  
  // File Info
  fileName        String
  fileUrl         String
  fileSize        Int      // bytes
  mimeType        String
  
  // Security
  scannedAt       DateTime?
  scanStatus      ScanStatus @default(PENDING)
  
  // Relations
  messageId       String
  
  message         Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())

  @@index([messageId])
  @@map("message_attachments")
}

enum ScanStatus {
  PENDING
  CLEAN
  INFECTED
  ERROR
}

// ======================
// EMAIL INTEGRATION
// ======================

model EmailIntegration {
  id              String   @id @default(uuid())
  
  // Provider
  provider        EmailProvider
  email           String
  
  // OAuth Tokens (encrypted in production)
  accessToken     String?
  refreshToken    String?
  tokenExpiresAt  DateTime?
  
  // Status
  isActive        Boolean  @default(true)
  lastSyncAt      DateTime?
  
  // Relations
  userId          String
  schoolId        String
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  school          School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, provider])
  @@index([schoolId])
  @@map("email_integrations")
}

enum EmailProvider {
  GMAIL
  OUTLOOK
  YAHOO
}
